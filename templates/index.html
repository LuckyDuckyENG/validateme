<!DOCTYPE html>
<html>
<head>
    <title>ValidateMe</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        input { width: 100%; padding: 10px; font-size: 16px; margin-bottom: 10px; }
        button { padding: 10px 20px; font-size: 16px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px; }
        button:hover { background: #0056b3; }
        .result { border: 1px solid #ddd; padding: 15px; margin: 15px 0; border-radius: 5px; }
        .username { color: #007bff; font-weight: bold; }
        .template { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; white-space: pre-wrap; }
        .copy-btn { background: #28a745; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; margin-top: 5px; }
        .copy-btn:hover { background: #218838; }
        .generate-btn { background: #007bff; color: white; border: none; padding: 8px 16px; cursor: pointer; border-radius: 3px; margin-top: 10px; }
        .generate-btn:hover { background: #0056b3; }
        .generate-btn:disabled { background: #ccc; cursor: not-allowed; }
        .templates-container { display: none; }
    </style>
</head>
<body>
    <h1>Find People to Validate With</h1>
    <input type="text" id="keywords" placeholder="What problem are you solving? (e.g., 'founders struggling with validation')">
    <button onclick="search()">Find People</button>

    <div id="results"></div>

    <script>
        async function search() {
            const keywords = document.getElementById('keywords').value;
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>Searching...</p>';

            const response = await fetch('/search', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({keywords})
            });

            const data = await response.json();

            resultsDiv.innerHTML = '';
            data.results.forEach((result, index) => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result';
                resultDiv.innerHTML = `
                    <div class="username">u/${result.username}</div>
                    <strong>${result.title}</strong>
                    <p>${result.snippet}</p>
                    <small>r/${result.subreddit} | ${result.score} upvotes | ${result.created_utc}</small>
                    <br>
                    <button class="generate-btn" onclick="generateDMs(${index})">Generate DM Templates</button>
                    <div class="templates-container" id="templates-${index}"></div>
                `;
                resultDiv.dataset.username = result.username;
                resultDiv.dataset.title = result.title;
                resultDiv.dataset.snippet = result.snippet;
                resultsDiv.appendChild(resultDiv);
            });
        }

        async function generateDMs(index) {
            const resultDiv = document.querySelectorAll('.result')[index];
            const btn = resultDiv.querySelector('.generate-btn');
            const templatesDiv = document.getElementById(`templates-${index}`);

            // Disable button and show loading
            btn.disabled = true;
            btn.textContent = 'Generating...';

            const username = resultDiv.dataset.username;
            const title = resultDiv.dataset.title;
            const snippet = resultDiv.dataset.snippet;

            try {
                const response = await fetch('/generate-dm', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, title, snippet})
                });

                const data = await response.json();

                // Show templates
                templatesDiv.style.display = 'block';
                templatesDiv.innerHTML = `
                    <h4>DM Templates:</h4>
                    <div class="template">
                        ${data.dm_templates.replace(/\n/g, '<br>')}
                        <br><button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
                    </div>
                `;

                // Hide button after generation
                btn.style.display = 'none';
            } catch (error) {
                btn.disabled = false;
                btn.textContent = 'Generate DM Templates';
                alert('Error generating templates. Please try again.');
            }
        }

        function copyToClipboard(btn) {
            const text = btn.parentElement.innerText.replace('Copy', '').trim();
            navigator.clipboard.writeText(text);
            btn.innerText = 'Copied!';
            setTimeout(() => btn.innerText = 'Copy', 2000);
        }
    </script>
</body>
</html>
